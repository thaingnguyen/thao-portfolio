---
import { Icon } from 'astro-icon/components';
import { getImage, type ImageMetadata } from 'astro:assets';

// Component Props
interface Props {
  showcaseId: string;
  title: string;
  subtitle: string;
  projects: any[]; // Define a more specific type if possible
  highlightColor?: 'blue' | 'pink';
}

const { 
  showcaseId,
  title,
  subtitle,
  projects,
  highlightColor = 'blue' // Default to blue
} = Astro.props;

const initialProject = projects[0];

// Normalize images so both local (ImageMetadata) and remote strings
// resolve to an object with a consistent `attributes` shape.
const processedImages = await Promise.all(projects.map(async (p) => {
  const media = p.media?.default ?? p.media;

  // Local import (ImageMetadata)
  if (typeof media === 'object' && media !== null && 'src' in media) {
    const img = await getImage({
      src: media as ImageMetadata,
      width: 800,
      height: 600,
      format: 'webp',
    });

    // Ensure a consistent attributes object exists
    const attrs = (img as any).attributes ?? {};
    return {
      ...img,
      attributes: {
        ...attrs,
        src: img.src,
        width: attrs.width ?? (img as any).width ?? 800,
        height: attrs.height ?? (img as any).height ?? 600,
      },
    };
  }

  // Remote URL string
  const src = String(media);
  return { src, attributes: { src, width: 800, height: 600 } };
}));

const firstImage = processedImages[0];

// Define color classes based on the highlightColor prop
const colorClasses = {
  blue: {
    text: 'text-accent-primary-strong',
    border: 'border-accent-primary-strong',
    icon: 'text-accent-primary',
    badge: 'bg-badge-primary text-white'
  },
  pink: {
    text: 'text-accent-secondary',
    border: 'border-accent-secondary',
    icon: 'text-accent-secondary',
    badge: 'bg-badge-secondary text-white'
  }
};

const colors = colorClasses[highlightColor];
---

<!-- Showcase Section -->
<section id={showcaseId} class="bg-surface-elevated py-20 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Section Header -->
        <header class="text-center mb-12">
            <h2 class="text-4xl md:text-5xl font-bold tracking-tight text-foreground">{title}</h2>
            <p class="text-foreground-muted mt-4 text-lg">{subtitle}</p>
        </header>

        <!-- Main Carousel Section -->
        <div id={`${showcaseId}-carousel-container`} class="bg-surface-alt rounded-2xl shadow-2xl overflow-hidden">
            

            <!-- Preview Navigation -->
            <div id={`${showcaseId}-preview-nav`} class="grid grid-cols-2 md:grid-cols-4 gap-px bg-surface-overlay border-t border-transparent">
                {projects.map((project, index) => (
                    <div 
                        class:list={[
                            "preview-card", "p-4", "cursor-pointer", "transition-colors", 
                            "duration-200", "border-b-4", "text-center",
                            index === 0 
                                ? ["active-card", colors.border, "bg-surface-overlay"] 
                                : "border-transparent bg-surface-alt/50 hover:bg-surface-elevated/50"
                        ]}
                        data-id={project.id}
                    >
                        <div class:list={["w-full flex justify-center mb-2", colors.icon]}>
                          <Icon name={project.icon} class="w-6 h-6" />
                        </div>
                        <p class="text-2xl font-bold text-secondary">{project.preview.value}</p>
                        <p class="text-xs text-foreground-muted mb-2">{project.preview.label}</p>
                        <h4 class="text-sm font-semibold text-secondary leading-tight">{project.preview.title}</h4>
                    </div>
                ))}
            </div>

            <!-- Featured Project Display -->
            <div id={`${showcaseId}-featured-project-container`} class="p-6 sm:p-8 lg:p-12 transition-opacity duration-300 ease-in-out">

                <!-- Details Section (Bottom Row) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
                    
                    <!-- Content Area (Left) -->
                    <div id={`${showcaseId}-left-content`} class="text-foreground-secondary order-2 lg:order-1 flex flex-col">
                        <p id={`${showcaseId}-featured-role`} class:list={["inline-block px-3 py-1 rounded-md text-sm mb-6 self-start uppercase", colors.icon, colors.badge]}>{initialProject.role}</p>
                        <h3 id={`${showcaseId}-featured-title`} class="text-2xl sm:text-3xl font-bold text-foreground mb-2">{initialProject.title}</h3>
                        
                        <div id={`${showcaseId}-description-wrapper`} style="min-height: 300px;">
                            <h4 class:list={["font-semibold mb-2", colors.text]}>The Challenge</h4>
                            <p id={`${showcaseId}-featured-challenge`} class="mb-6 text-base leading-relaxed text-foreground-muted">{initialProject.challenge}</p>
                            
                            <h4 class:list={["font-semibold mb-2", colors.text]}>My Approach & Solution</h4>
                            <ul id={`${showcaseId}-featured-solution`} class="list-disc list-inside space-y-2 text-base leading-relaxed text-foreground-muted">
                                {initialProject.solution.map(item => (
                                    <li set:html={item} />
                                ))}
                            </ul>
                        </div>
                    </div>

                    <!-- Media Area (Right) -->
                    <div class="w-full h-auto aspect-video rounded-lg overflow-hidden bg-surface-overlay order-1 lg:order-2">
                        <img id={`${showcaseId}-featured-media`} {...firstImage.attributes} alt={`${initialProject.title} media`} class="w-full h-full object-cover">
                    </div>

                </div>

                <!-- Impact Section (Top Row) -->
                <div id={`${showcaseId}-featured-impact`} class="grid grid-cols-3 gap-4 sm:gap-8 mb-8 md:mb-12 text-center">
                    {initialProject.impact.map(metric => (
                        <div>
                            <p class:list={["text-3xl sm:text-4xl lg:text-6xl font-black tracking-tighter", colors.text]}>{metric.value}</p>
                            <p class="text-foreground-muted text-xs sm:text-sm mt-1">{metric.label}</p>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </div>
</section>
<style>
  .active-card {
      background-color: rgb(var(--rgb-surface-overlay) / 0.5);
  }
</style>

<script define:vars={{ projects, showcaseId, highlightColor, processedImages }}>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById(showcaseId);
    if (!container) return;

    const colorClasses = {
      blue: {
        text: 'text-accent-primary-strong',
        border: 'border-accent-primary-strong',
      },
      pink: {
        text: 'text-accent-secondary',
        border: 'border-accent-secondary',
      }
    };
    const colors = colorClasses[highlightColor];

    const featuredMedia = container.querySelector(`#${showcaseId}-featured-media`);
    const featuredTitle = container.querySelector(`#${showcaseId}-featured-title`);
    const featuredChallenge = container.querySelector(`#${showcaseId}-featured-challenge`);
    const featuredSolution = container.querySelector(`#${showcaseId}-featured-solution`);
    const featuredRole = container.querySelector(`#${showcaseId}-featured-role`);
    const featuredImpact = container.querySelector(`#${showcaseId}-featured-impact`);
    const featuredProjectContainer = container.querySelector(`#${showcaseId}-featured-project-container`);
    const previewNav = container.querySelector(`#${showcaseId}-preview-nav`);
    const leftContent = container.querySelector(`#${showcaseId}-left-content`);
    const descriptionWrapper = container.querySelector(`#${showcaseId}-description-wrapper`);

    const previewCards = previewNav.querySelectorAll('.preview-card');

    function computeStableHeights() {
      // Stabilize the left content column (role, title, description)
      if (leftContent) {
        const measure = document.createElement('div');
        measure.style.position = 'absolute';
        measure.style.visibility = 'hidden';
        measure.style.pointerEvents = 'none';
        measure.style.left = '-10000px';
        measure.style.top = '0';
        measure.style.width = `${leftContent.clientWidth}px`;
        document.body.appendChild(measure);

        let maxLeftHeight = 0;
        projects.forEach((p) => {
          measure.innerHTML = `
            <p class="bg-surface-overlay/50 inline-block px-3 py-1 rounded-md text-sm mb-6 self-start">${p.role}</p>
            <h3 class="text-2xl sm:text-3xl font-bold text-foreground mb-2">${p.title}</h3>
            <div>
              <h4 class="font-semibold mb-2">The Challenge</h4>
              <p class="mb-6 text-base leading-relaxed text-foreground-muted">${p.challenge}</p>
              <h4 class="font-semibold mb-2">My Approach & Solution</h4>
              <ul class="list-disc list-inside space-y-2 text-base leading-relaxed text-foreground-muted">
                ${(p.solution || []).map((item) => `<li>${item}</li>`).join('')}
              </ul>
            </div>
          `;
          const h = measure.offsetHeight;
          if (h > maxLeftHeight) maxLeftHeight = h;
        });
        document.body.removeChild(measure);
        leftContent.style.minHeight = `${Math.ceil(maxLeftHeight)}px`;
      }

      // Stabilize the top impact metrics grid
      if (featuredImpact) {
        const measureImpact = document.createElement('div');
        measureImpact.style.position = 'absolute';
        measureImpact.style.visibility = 'hidden';
        measureImpact.style.pointerEvents = 'none';
        measureImpact.style.left = '-10000px';
        measureImpact.style.top = '0';
        measureImpact.style.width = `${featuredImpact.clientWidth}px`;
        measureImpact.className = 'grid grid-cols-3 gap-4 sm:gap-8 text-center';
        document.body.appendChild(measureImpact);

        let maxImpactHeight = 0;
        projects.forEach((p) => {
          measureImpact.innerHTML = (p.impact || []).map((metric) => `
            <div>
              <p class="text-3xl sm:text-4xl lg:text-6xl font-black tracking-tighter">${metric.value}</p>
              <p class="text-foreground-muted text-xs sm:text-sm mt-1">${metric.label}</p>
            </div>
          `).join('');
          const h = measureImpact.offsetHeight;
          if (h > maxImpactHeight) maxImpactHeight = h;
        });
        document.body.removeChild(measureImpact);
        featuredImpact.style.minHeight = `${Math.ceil(maxImpactHeight)}px`;
      }
    }

    function updateFeaturedProject(projectId) {
      const projectIndex = projects.findIndex(p => p.id === parseInt(projectId));
      if (projectIndex === -1) return;
      
      const project = projects[projectIndex];
      const processedImage = processedImages[projectIndex];

      if (!project || !processedImage) return;

      featuredProjectContainer.style.opacity = '0';
      setTimeout(() => {
        // The 'attributes' object will exist for both local and remote images
        for (const [key, value] of Object.entries(processedImage.attributes)) {
          featuredMedia.setAttribute(key, value);
        }
        featuredMedia.alt = `${project.title} media`;
        
        featuredTitle.textContent = project.title;
        featuredRole.textContent = project.role;
        featuredChallenge.textContent = project.challenge;

        featuredSolution.innerHTML = '';
        project.solution.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = item;
            featuredSolution.appendChild(li);
        });

        featuredImpact.innerHTML = '';
        project.impact.forEach(metric => {
          const impactEl = document.createElement('div');
          impactEl.innerHTML = `
            <p class="text-3xl sm:text-4xl lg:text-6xl font-black ${colors.text} tracking-tighter">${metric.value}</p>
            <p class="text-foreground-muted text-xs sm:text-sm mt-1">${metric.label}</p>
          `;
          featuredImpact.appendChild(impactEl);
        });
        featuredProjectContainer.style.opacity = '1';
      }, 300);

      previewCards.forEach(card => {
        card.classList.remove(
          'active-card',
          colorClasses.blue.border,
          colorClasses.pink.border,
          'bg-surface-overlay',
          'border-transparent'
        );
        card.classList.add('bg-surface-alt/50', 'hover:bg-surface-elevated/50');

        if (parseInt(card.dataset.id) === projectId) {
          card.classList.add('active-card', colors.border, 'bg-surface-overlay');
          card.classList.remove('hover:bg-surface-elevated/50');
        } else {
          card.classList.add('border-transparent');
        }
      });
    }

    previewCards.forEach(card => {
      card.addEventListener('click', () => {
        updateFeaturedProject(parseInt(card.dataset.id));
      });
    });

    // Compute stable heights initially and on resize to prevent layout shift
    computeStableHeights();
    let resizeTO;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTO);
      resizeTO = setTimeout(computeStableHeights, 150);
    });
  });
</script>
